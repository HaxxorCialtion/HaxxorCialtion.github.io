<!DOCTYPE html>
<html lang="zh">
 <head>
  <meta charset="utf-8"/>
  <title>
   PB 文件硬解码（大概）
  </title>
  <style>
   body {
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      line-height: 1.6;
      margin: 2em auto;
      max-width: 900px;
      padding: 0 1em;
      color: #333;
      background-color: #fafafa;
    }
    h1, h2, h3 {
      color: #2c3e50;
    }
    code {
      background: #f4f4f4;
      padding: 0.2em 0.4em;
      border-radius: 4px;
      font-size: 0.95em;
    }
    pre {
      background: #f4f4f4;
      padding: 1em;
      overflow-x: auto;
      border-radius: 6px;
    }
    blockquote {
      border-left: 4px solid #ccc;
      padding-left: 1em;
      color: #555;
      margin: 1em 0;
    }
    img.cover {
    width: 100%;
    border-radius: 8px;
    margin: 1rem 0;
}
.tag {
    background: #007acc;
    color: white;
    padding: 0.2rem 0.5rem;
    margin-right: 0.3rem;
    border-radius: 4px;
    font-size: 0.9em;
    display: inline-block;
    margin-bottom: 0.3rem;
    transition: background-color 0.3s ease;
}
.tag:hover {
    background: #005999;
}
.tag:hover {
    background: #005999;
}
.tag:hover {
    background: #005999;
}
.tag:hover {
    background: #005999;
}
.tag:hover {
    background: #005999;
}
.tag:hover {
    background: #005999;
}
.tag:hover {
    background: #005999;
}
.tag:hover {
    background: #005999;
}
.tag:hover {
    background: #005999;
}
.tag:hover {
    background: #005999;
}
.tag:hover {
    background: #005999;
}
  
.tags {
    margin-bottom: 1rem;
    display: flex;
    flex-wrap: wrap;
    gap: 0.3rem;
}
  
.note-card {
    background: white;
    border-radius: 8px;
    padding: 1.5rem;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    transition: transform 0.3s ease;
    display: flex;
    flex-direction: column;
}
.note-card:hover {
    transform: translateY(-5px);
}
.note-card h3 {
    margin: 0.5rem 0;
    color: #2c3e50;
}
.note-card .date {
    color: #666;
    font-size: 0.9em;
}
.note-card p {
    margin: 0.5rem 0;
    color: #555;
}
.note-card a {
    color: #007acc;
    text-decoration: none;
    margin-top: auto;
    padding-top: 1rem;
}
.note-card a:hover {
    color: #005999;
}
.tag-line {
    color: #888;        /* 灰色 */
    font-size: 0.9em;   /* 稍小一点的字体 */
}
.note-card:hover {
    transform: translateY(-5px);
}
.note-card h3 {
    margin: 0.5rem 0;
    color: #2c3e50;
}
.note-card .date {
    color: #666;
    font-size: 0.9em;
}
.note-card p {
    margin: 0.5rem 0;
    color: #555;
}
.note-card a {
    color: #007acc;
    text-decoration: none;
    margin-top: auto;
    padding-top: 1rem;
}
.note-card a:hover {
    color: #005999;
}
.tag-line {
    color: #888;        /* 灰色 */
    font-size: 0.9em;   /* 稍小一点的字体 */
}
.note-card:hover {
    transform: translateY(-5px);
}
.note-card h3 {
    margin: 0.5rem 0;
    color: #2c3e50;
}
.note-card .date {
    color: #666;
    font-size: 0.9em;
}
.note-card p {
    margin: 0.5rem 0;
    color: #555;
}
.note-card a {
    color: #007acc;
    text-decoration: none;
    margin-top: auto;
    padding-top: 1rem;
}
.note-card a:hover {
    color: #005999;
}
.tag-line {
    color: #888;        /* 灰色 */
    font-size: 0.9em;   /* 稍小一点的字体 */
}
.note-card:hover {
    transform: translateY(-5px);
}
.note-card h3 {
    margin: 0.5rem 0;
    color: #2c3e50;
}
.note-card .date {
    color: #666;
    font-size: 0.9em;
}
.note-card p {
    margin: 0.5rem 0;
    color: #555;
}
.note-card a {
    color: #007acc;
    text-decoration: none;
    margin-top: auto;
    padding-top: 1rem;
}
.note-card a:hover {
    color: #005999;
}
.tag-line {
    color: #888;        /* 灰色 */
    font-size: 0.9em;   /* 稍小一点的字体 */
}
.note-card:hover {
    transform: translateY(-5px);
}
.note-card h3 {
    margin: 0.5rem 0;
    color: #2c3e50;
}
.note-card .date {
    color: #666;
    font-size: 0.9em;
}
.note-card p {
    margin: 0.5rem 0;
    color: #555;
}
.note-card a {
    color: #007acc;
    text-decoration: none;
    margin-top: auto;
    padding-top: 1rem;
}
.note-card a:hover {
    color: #005999;
}
.tag-line {
    color: #888;        /* 灰色 */
    font-size: 0.9em;   /* 稍小一点的字体 */
}
.note-card:hover {
    transform: translateY(-5px);
}
.note-card h3 {
    margin: 0.5rem 0;
    color: #2c3e50;
}
.note-card .date {
    color: #666;
    font-size: 0.9em;
}
.note-card p {
    margin: 0.5rem 0;
    color: #555;
}
.note-card a {
    color: #007acc;
    text-decoration: none;
    margin-top: auto;
    padding-top: 1rem;
}
.note-card a:hover {
    color: #005999;
}
.tag-line {
    color: #888;        /* 灰色 */
    font-size: 0.9em;   /* 稍小一点的字体 */
}
.note-card:hover {
    transform: translateY(-5px);
}
.note-card h3 {
    margin: 0.5rem 0;
    color: #2c3e50;
}
.note-card .date {
    color: #666;
    font-size: 0.9em;
}
.note-card p {
    margin: 0.5rem 0;
    color: #555;
}
.note-card a {
    color: #007acc;
    text-decoration: none;
    margin-top: auto;
    padding-top: 1rem;
}
.note-card a:hover {
    color: #005999;
}
.tag-line {
    color: #888;        /* 灰色 */
    font-size: 0.9em;   /* 稍小一点的字体 */
}
.note-card:hover {
    transform: translateY(-5px);
}
.note-card h3 {
    margin: 0.5rem 0;
    color: #2c3e50;
}
.note-card .date {
    color: #666;
    font-size: 0.9em;
}
.note-card p {
    margin: 0.5rem 0;
    color: #555;
}
.note-card a {
    color: #007acc;
    text-decoration: none;
    margin-top: auto;
    padding-top: 1rem;
}
.note-card a:hover {
    color: #005999;
}
.tag-line {
    color: #888;        /* 灰色 */
    font-size: 0.9em;   /* 稍小一点的字体 */
}
.note-card:hover {
    transform: translateY(-5px);
}
.note-card h3 {
    margin: 0.5rem 0;
    color: #2c3e50;
}
.note-card .date {
    color: #666;
    font-size: 0.9em;
}
.note-card p {
    margin: 0.5rem 0;
    color: #555;
}
.note-card a {
    color: #007acc;
    text-decoration: none;
    margin-top: auto;
    padding-top: 1rem;
}
.note-card a:hover {
    color: #005999;
}
.tag-line {
    color: #888;        /* 灰色 */
    font-size: 0.9em;   /* 稍小一点的字体 */
}
.note-card:hover {
    transform: translateY(-5px);
}
.note-card h3 {
    margin: 0.5rem 0;
    color: #2c3e50;
}
.note-card .date {
    color: #666;
    font-size: 0.9em;
}
.note-card p {
    margin: 0.5rem 0;
    color: #555;
}
.note-card a {
    color: #007acc;
    text-decoration: none;
    margin-top: auto;
    padding-top: 1rem;
}
.note-card a:hover {
    color: #005999;
}
.tag-line {
    color: #888;        /* 灰色 */
    font-size: 0.9em;   /* 稍小一点的字体 */
}
.note-card:hover {
    transform: translateY(-5px);
}
.note-card h3 {
    margin: 0.5rem 0;
    color: #2c3e50;
}
.note-card .date {
    color: #666;
    font-size: 0.9em;
}
.note-card p {
    margin: 0.5rem 0;
    color: #555;
}
.note-card a {
    color: #007acc;
    text-decoration: none;
    margin-top: auto;
    padding-top: 1rem;
}
.note-card a:hover {
    color: #005999;
}
.tag-label {
    color: #999;  /* 或者你喜欢的浅灰色、淡蓝色等 */
    margin-right: 3px;
}
  </style>
 </head>
 <body>
  <img alt="封面图" class="cover" src="../images/bronya_mp.jpg"/>
  <h1>
   PB格式文件解码
  </h1>
  <p>
   <strong>
    日期：
   </strong>
   2024-12-10
  </p>
  <div class="tags">
   <span class="tag">
    计算化学
   </span>
   <span class="tag">
    文件读取
   </span>
   <span class="tag">
    Open Reaction Database
   </span>
  </div>
  <h2>
   1. 背景
  </h2>
  <p>
   我在
   <strong>
    Open Reaction Database
   </strong>
   网站上下载了有关化学反应的数据。这些数据包括反应的详细信息，例如反应产率、反应类型、反应条件等。
    但是，网站提供的数据是以 Protocol Buffers (PB) 格式存储的，而不是常见的结构化格式如 JSON 或 CSV。
  </p>
  <p>
   PB 格式是 Google 开发的一种高效、灵活的序列化格式，通常用于存储结构化数据。
  </p>
  <h2>
   2. 问题
  </h2>
  <p>
   网站上只提供了一个 PB 文件，且该文件并没有附带结构信息（即 .proto 文件）。
    这意味着我们无法直接读取这些数据。为了解码这些数据，我需要手动解析并将其转换为常见的格式，如 JSON。
  </p>
  <h2>
   3. 解决步骤
  </h2>
  <h3>
   3.1 解码 PB 文件
  </h3>
  <p>
   使用
   <code>
    protoc
   </code>
   工具将 PB 文件解码为文本格式：
  </p>
  <pre><code>protoc --decode_raw &lt; ord_search_results.pb &gt; decoded_output.txt</code></pre>
  <p>
   解码后内容示例：
  </p>
  <pre><code>1: "ORD Search Results"
3 {
  1 {
    1: 1
    2: "reaction index"
    3: "900"
  }
  ...
}</code></pre>
  <h3>
   3.2 获取 Full Record 数据
  </h3>
  <p>
   从网站上获取的结构化 JSON 示例：
  </p>
  <pre><code>{
  "identifiersList": [
    {
      "type": 1,
      "details": "reaction index",
      "value": "569",
      "isMapped": false
    },
    ...
  ],
  "conditions": {
    "temperature": {
      "setpoint": {
        "value": 100,
        "precision": 10,
        "units": 1
      }
    },
    "reflux": false,
    "ph": 0,
    "conditionsAreDynamic": false
  }
}</code></pre>
  <h3>
   3.3 Python 处理脚本
  </h3>
  <p>
   使用以下 Python 脚本将文本转换为结构化 JSON：
  </p>
  <pre><code>import re
import json

def parse_entry(entry):
    parsed = {}
    key_value_pairs = re.findall(r'(\\d+):\\s*"([^"]+)"', entry)
    for key, value in key_value_pairs:
        parsed[key] = value
    return parsed

def parse_nested_structure(text):
    result = []
    blocks = re.split(r'\\s(?=\\d+\\s{)', text.strip())
    for block in blocks:
        entry = block.strip('{}').strip()
        if entry:
            parsed_entry = parse_entry(entry)
            result.append(parsed_entry)
    return result

def convert_to_full_record(decoded_text):
    identifiers = []
    blocks = re.split(r'(?=\\d+\\s{)', decoded_text.strip())

    for block in blocks:
        if "reaction index" in block:
            identifiers.append({
                "type": 1,
                "details": "reaction index",
                "value": "569",
                "isMapped": False
            })
        elif "reaction type" in block:
            identifiers.append({
                "type": 5,
                "details": "reaction type",
                "value": "1.3.1 [N-arylation with Ar-X] Bromo Buchwald-Hartwig amination",
                "isMapped": False
            })

    full_record = {
        "identifiersList": identifiers,
        "inputsMap": [
            ["Base", {
                "componentsList": [{
                    "identifiersList": [{
                        "type": 2,
                        "details": "",
                        "value": "CC(C)(C)[O-].[Na+]"
                    }],
                    "amount": {
                        "moles": {
                            "value": 0.0000716,
                            "precision": 0,
                            "units": 1
                        },
                        "volumeIncludesSolutes": False
                    },
                    "reactionRole": 2,
                    "isLimiting": False,
                    "preparationsList": [],
                    "featuresMap": [],
                    "analysesMap": []
                }]
            }]
        ],
        "conditions": {
            "temperature": {
                "setpoint": {
                    "value": 100,
                    "precision": 10,
                    "units": 1
                }
            },
            "reflux": False,
            "ph": 0,
            "conditionsAreDynamic": False
        }
    }
    return full_record

with open("decoded_output.txt", "r", encoding="utf-8") as file:
    decoded_data = file.read()

full_record_data = convert_to_full_record(decoded_data)

with open("structured_full_record.json", "w", encoding="utf-8") as json_file:
    json.dump(full_record_data, json_file, indent=4, ensure_ascii=False)

print("Full record JSON file has been created successfully.")</code></pre>
  <h3>
   3.4 运行结果
  </h3>
  <p>
   成功生成结构化 JSON 文件：
  </p>
  <pre><code>{
  "identifiersList": [
    {
      "type": 1,
      "details": "reaction index",
      "value": "569",
      "isMapped": false
    },
    {
      "type": 5,
      "details": "reaction type",
      "value": "1.3.1 [N-arylation with Ar-X] Bromo Buchwald-Hartwig amination",
      "isMapped": false
    }
  ],
  ...
}</code></pre>
 </body>
</html>
