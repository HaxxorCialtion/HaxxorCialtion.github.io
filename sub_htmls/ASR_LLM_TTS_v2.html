<!DOCTYPE html>
<html lang="zh-CN">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>
   ASR-LLM-TTS é«˜æ•ˆè¯­éŸ³å¯¹è¯ç³»ç»Ÿ
  </title>
  <style>
   :root {
            --primary-color: #4a6fa5;
            --secondary-color: #27ae60;
            --bg-color: #f8f9fa;
            --code-bg: #f5f7f9;
            --text-color: #2c3e50;
            --border-color: #e0e0e0;
            --comment-color: #6c757d;
            --keyword-color: #8e44ad;
            --function-color: #2980b9;
            --string-color: #27ae60;
            --number-color: #e67e22;
            --class-color: #e74c3c;
            --builtin-color: #1abc9c;
        }

        body {
            font-family: 'Source Han Sans CN', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 20px;
            background-color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border-radius: 5px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        h1 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .subtitle {
            color: var(--comment-color);
            font-size: 1.1rem;
            font-weight: 400;
        }

        .section {
            margin-bottom: 30px;
        }

        h2 {
            color: var(--primary-color);
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-color);
            display: inline-block;
        }

        h3 {
            color: var(--secondary-color);
            margin-top: 20px;
        }

        pre {
            background-color: var(--code-bg);
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-family: 'Source Code Pro', Consolas, Monaco, 'Andale Mono', monospace;
            position: relative;
            margin: 15px 0;
            line-height: 1.5;
        }

        code {
            font-family: 'Source Code Pro', Consolas, Monaco, 'Andale Mono', monospace;
        }

        .code-block {
            position: relative;
        }

        .language-label {
            position: absolute;
            top: 0;
            right: 0;
            background-color: var(--primary-color);
            color: white;
            padding: 3px 8px;
            font-size: 12px;
            border-radius: 0 5px 0 5px;
        }

        .comment { color: var(--comment-color); }
        .keyword { color: var(--keyword-color); }
        .function { color: var(--function-color); }
        .string { color: var(--string-color); }
        .number { color: var(--number-color); }
        .class { color: var(--class-color); }
        .builtin { color: var(--builtin-color); }

        .architecture {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            margin: 20px 0;
        }

        .component {
            background-color: white;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
            width: calc(33% - 20px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .component h4 {
            color: var(--primary-color);
            margin-top: 0;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
        }

        .component ul {
            padding-left: 20px;
        }

        .flowchart {
            text-align: center;
            margin: 30px 0;
        }

        .flowchart svg {
            max-width: 100%;
            height: auto;
        }

        @media (max-width: 768px) {
            .component {
                width: 100%;
            }
        }

        .features {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 20px 0;
        }

        .feature {
            background-color: var(--code-bg);
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid var(--secondary-color);
            width: calc(50% - 30px);
        }

        @media (max-width: 768px) {
            .feature {
                width: 100%;
            }
        }

        .feature h4 {
            margin-top: 0;
            color: var(--secondary-color);
        }

        .footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
            color: var(--comment-color);
            font-size: 0.9rem;
        }

        .class-header {
            background-color: #f1f8e9;
            padding: 8px 15px;
            border-radius: 5px 5px 0 0;
            border-left: 4px solid #8bc34a;
            margin-bottom: -15px;
            font-weight: bold;
            color: #33691e;
        }

        .method-header {
            background-color: #e8f5e9;
            padding: 5px 15px;
            margin-top: 15px;
            border-left: 4px solid #4caf50;
            font-weight: 500;
            color: #2e7d32;
        }
    
img.cover {
    width: 100%;
    border-radius: 8px;
    margin: 1rem 0;
}
.tag {
    background: #007acc;
    color: white;
    padding: 0.2rem 0.5rem;
    margin-right: 0.3rem;
    border-radius: 4px;
    font-size: 0.9em;
    display: inline-block;
    margin-bottom: 0.3rem;
    transition: background-color 0.3s ease;
}
.tag:hover {
    background: #005999;
}
.tag:hover {
    background: #005999;
}
.tag:hover {
    background: #005999;
}
.tag:hover {
    background: #005999;
}
.tags {
    margin-bottom: 1rem;
    display: flex;
    flex-wrap: wrap;
    gap: 0.3rem;
}
.note-card {
    background: white;
    border-radius: 8px;
    padding: 1.5rem;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    transition: transform 0.3s ease;
    display: flex;
    flex-direction: column;
}
.note-card:hover {
    transform: translateY(-5px);
}
.note-card h3 {
    margin: 0.5rem 0;
    color: #2c3e50;
}
.note-card .date {
    color: #666;
    font-size: 0.9em;
}
.note-card p {
    margin: 0.5rem 0;
    color: #555;
}
.note-card a {
    color: #007acc;
    text-decoration: none;
    margin-top: auto;
    padding-top: 1rem;
}
.note-card a:hover {
    color: #005999;
}
.tag-line {
    color: #888;        /* ç°è‰² */
    font-size: 0.9em;   /* ç¨å°ä¸€ç‚¹çš„å­—ä½“ */
}
.note-card:hover {
    transform: translateY(-5px);
}
.note-card h3 {
    margin: 0.5rem 0;
    color: #2c3e50;
}
.note-card .date {
    color: #666;
    font-size: 0.9em;
}
.note-card p {
    margin: 0.5rem 0;
    color: #555;
}
.note-card a {
    color: #007acc;
    text-decoration: none;
    margin-top: auto;
    padding-top: 1rem;
}
.note-card a:hover {
    color: #005999;
}
.tag-line {
    color: #888;        /* ç°è‰² */
    font-size: 0.9em;   /* ç¨å°ä¸€ç‚¹çš„å­—ä½“ */
}
.note-card:hover {
    transform: translateY(-5px);
}
.note-card h3 {
    margin: 0.5rem 0;
    color: #2c3e50;
}
.note-card .date {
    color: #666;
    font-size: 0.9em;
}
.note-card p {
    margin: 0.5rem 0;
    color: #555;
}
.note-card a {
    color: #007acc;
    text-decoration: none;
    margin-top: auto;
    padding-top: 1rem;
}
.note-card a:hover {
    color: #005999;
}
.tag-line {
    color: #888;        /* ç°è‰² */
    font-size: 0.9em;   /* ç¨å°ä¸€ç‚¹çš„å­—ä½“ */
}
.note-card:hover {
    transform: translateY(-5px);
}
.note-card h3 {
    margin: 0.5rem 0;
    color: #2c3e50;
}
.note-card .date {
    color: #666;
    font-size: 0.9em;
}
.note-card p {
    margin: 0.5rem 0;
    color: #555;
}
.note-card a {
    color: #007acc;
    text-decoration: none;
    margin-top: auto;
    padding-top: 1rem;
}
.note-card a:hover {
    color: #005999;
}
.tag-line {
    color: #888;        /* ç°è‰² */
    font-size: 0.9em;   /* ç¨å°ä¸€ç‚¹çš„å­—ä½“ */
}
  </style>
 </head>
 <body>
  <img alt="å°é¢å›¾" class="cover" src="../images/bronya_mp.jpg"/>
  <h1>
   ASR_LLM_TTS_ç†è®ºé«˜æ•ˆç‰ˆ
  </h1>
  <p>
   <strong>
    æ—¥æœŸï¼š
   </strong>
   2025-4-28
  </p>
  <div class="tags">
   <span class="tag">
    Raspberry Pi
   </span>
   <span class="tag">
    network
   </span>
   <span class="tag">
    æ ‘è“æ´¾4B
   </span>
  </div>
  <div class="container">
   <header>
    <h1>
     ASR-LLM-TTS é«˜æ•ˆè¯­éŸ³å¯¹è¯ç³»ç»Ÿ
    </h1>
    <p class="subtitle">
     ä¸€ä¸ªé«˜æ€§èƒ½è¯­éŸ³äº¤äº’ç³»ç»Ÿï¼Œä½¿ç”¨ Faster-Whisper-Turboã€vLLM å’Œ F5-TTS (TensorRT)
    </p>
   </header>
   <div class="section">
    <h2>
     ç³»ç»Ÿæ¶æ„
    </h2>
    <div class="architecture">
     <div class="component">
      <h4>
       ASRï¼ˆè¯­éŸ³è¯†åˆ«ï¼‰
      </h4>
      <ul>
       <li>
        ä½¿ç”¨ Faster-Whisper-Turbo æ¨¡å‹
       </li>
       <li>
        CUDA åŠ é€Ÿï¼ŒFP16 ç²¾åº¦
       </li>
       <li>
        å†…ç½® VAD è¿‡æ»¤åŠŸèƒ½
       </li>
      </ul>
     </div>
     <div class="component">
      <h4>
       LLMï¼ˆå¤§å‹è¯­è¨€æ¨¡å‹ï¼‰
      </h4>
      <ul>
       <li>
        ä½¿ç”¨ vLLM éƒ¨ç½²
       </li>
       <li>
        æœ¬åœ° REST API æ¥å£
       </li>
       <li>
        é«˜ååé‡æ¨ç†å¼•æ“
       </li>
      </ul>
     </div>
     <div class="component">
      <h4>
       TTSï¼ˆè¯­éŸ³åˆæˆï¼‰
      </h4>
      <ul>
       <li>
        F5-TTS çš„ TensorRT ä¼˜åŒ–ç‰ˆæœ¬
       </li>
       <li>
        æ”¯æŒå‚è€ƒéŸ³é¢‘å…‹éš†
       </li>
       <li>
        å¹¶è¡Œå¤„ç†å¤šæ®µæ–‡æœ¬
       </li>
      </ul>
     </div>
    </div>
    <div class="flowchart">
     <svg height="200" viewbox="0 0 800 200" width="800">
      <defs>
       <marker id="arrowhead" markerheight="7" markerwidth="10" orient="auto" refx="0" refy="3.5">
        <polygon fill="#4a6fa5" points="0 0, 10 3.5, 0 7">
        </polygon>
       </marker>
      </defs>
      <rect fill="#e8f4f8" height="60" rx="8" stroke="#4a6fa5" stroke-width="2" width="150" x="50" y="70">
      </rect>
      <text fill="#2c3e50" font-weight="bold" text-anchor="middle" x="125" y="105">
       å½•éŸ³/è¯­éŸ³è¾“å…¥
      </text>
      <line marker-end="url(#arrowhead)" stroke="#4a6fa5" stroke-width="2" x1="200" x2="250" y1="100" y2="100">
      </line>
      <rect fill="#e3f2fd" height="60" rx="8" stroke="#1565c0" stroke-width="2" width="150" x="250" y="70">
      </rect>
      <text fill="#2c3e50" font-weight="bold" text-anchor="middle" x="325" y="105">
       ASR è¯­éŸ³è¯†åˆ«
      </text>
      <line marker-end="url(#arrowhead)" stroke="#4a6fa5" stroke-width="2" x1="400" x2="450" y1="100" y2="100">
      </line>
      <rect fill="#f3e5f5" height="60" rx="8" stroke="#7b1fa2" stroke-width="2" width="150" x="450" y="70">
      </rect>
      <text fill="#2c3e50" font-weight="bold" text-anchor="middle" x="525" y="105">
       LLM æ¨¡å‹å¤„ç†
      </text>
      <line marker-end="url(#arrowhead)" stroke="#4a6fa5" stroke-width="2" x1="600" x2="650" y1="100" y2="100">
      </line>
      <rect fill="#e8f5e9" height="60" rx="8" stroke="#2e7d32" stroke-width="2" width="150" x="650" y="70">
      </rect>
      <text fill="#2c3e50" font-weight="bold" text-anchor="middle" x="725" y="105">
       TTS è¯­éŸ³åˆæˆ
      </text>
     </svg>
    </div>
   </div>
   <div class="section">
    <h2>
     ä¸»è¦ç‰¹æ€§
    </h2>
    <div class="features">
     <div class="feature">
      <h4>
       é«˜æ•ˆè¯­éŸ³å¤„ç†
      </h4>
      <p>
       ä½¿ç”¨é™éŸ³æ£€æµ‹å’Œ VAD æŠ€æœ¯å®ç°é«˜æ•ˆå½•éŸ³ï¼Œå‡å°‘å“åº”å»¶è¿Ÿã€‚ç³»ç»Ÿä¼šç¼“å­˜ 300ms çš„éŸ³é¢‘ä»¥æ•æ‰å®Œæ•´è¯­éŸ³èµ·å§‹ã€‚
      </p>
     </div>
     <div class="feature">
      <h4>
       å¹¶è¡Œ TTS å¤„ç†
      </h4>
      <p>
       æ–‡æœ¬åˆ†æ®µå¤„ç†å’Œå¹¶è¡Œåˆæˆï¼Œé¦–æ®µä¼˜å…ˆæ’­æ”¾ï¼Œå…¶ä½™éƒ¨åˆ†å¹¶è¡Œå¤„ç†ï¼Œæ˜¾è‘—æé«˜å“åº”é€Ÿåº¦ã€‚
      </p>
     </div>
     <div class="feature">
      <h4>
       æ€§èƒ½ç›‘æ§
      </h4>
      <p>
       å†…ç½®æ€§èƒ½è®¡æ—¶å™¨ï¼Œè®°å½•å„ä¸ªå¤„ç†é˜¶æ®µçš„è€—æ—¶ï¼Œä¾¿äºæ€§èƒ½åˆ†æå’Œä¼˜åŒ–ã€‚
      </p>
     </div>
     <div class="feature">
      <h4>
       æ—¥å¿—è®°å½•
      </h4>
      <p>
       è‡ªåŠ¨ä¿å­˜è¾“å…¥éŸ³é¢‘å’Œè¾“å‡ºåˆæˆè¯­éŸ³ï¼Œä¾¿äºè¿½è¸ªå’Œåˆ†æç³»ç»Ÿè¡Œä¸ºã€‚
      </p>
     </div>
    </div>
   </div>
   <div class="section">
    <h2>
     ä»£ç è¯¦è§£
    </h2>
    <h3>
     å¯¼å…¥ä¾èµ–
    </h3>
    <div class="code-block">
     <div class="language-label">
      Python
     </div>
     <pre>
<span class="keyword">import</span> os
<span class="keyword">import</span> time
<span class="keyword">import</span> wave
<span class="keyword">import</span> numpy <span class="keyword">as</span> np
<span class="keyword">import</span> requests
<span class="keyword">import</span> soundfile <span class="keyword">as</span> sf
<span class="keyword">import</span> pyaudio
<span class="keyword">import</span> datetime
<span class="keyword">import</span> threading
<span class="keyword">import</span> queue
<span class="keyword">import</span> concurrent.futures
<span class="keyword">from</span> pathlib <span class="keyword">import</span> Path
<span class="keyword">from</span> faster_whisper <span class="keyword">import</span> WhisperModel
<span class="keyword">from</span> openai <span class="keyword">import</span> OpenAI
<span class="keyword">import</span> sounddevice <span class="keyword">as</span> sd</pre>
    </div>
    <h3>
     ç³»ç»Ÿé…ç½®
    </h3>
    <div class="code-block">
     <div class="language-label">
      Python
     </div>
     <pre>
<span class="comment"># éŸ³é¢‘å‚æ•°</span>
CHUNK = <span class="number">1024</span>
FORMAT = pyaudio.paFloat32
CHANNELS = <span class="number">1</span>
RATE = <span class="number">16000</span>
SILENCE_THRESHOLD = <span class="number">0.01</span>
SILENCE_DURATION = <span class="number">0.8</span>  <span class="comment"># é™ä½é™éŸ³åˆ¤æ–­æ—¶é—´ä»¥åŠ å¿«å“åº”é€Ÿåº¦</span>

<span class="comment"># ASRæ¨¡å‹è·¯å¾„</span>
ASR_MODEL_PATH = <span class="string">"./whisper_turbo"</span>

<span class="comment"># LLM API</span>
LLM_BASE_URL = <span class="string">"http://localhost:6001/v1"</span>
LLM_API_KEY = <span class="string">"token-abc123"</span>
LLM_MODEL_PATH = <span class="string">"./Qwen/Qwen2___5-3B-Instruct-AWQ"</span>

<span class="comment"># TTSæœåŠ¡</span>
TTS_SERVER_URL = <span class="string">"localhost:8000"</span>
TTS_MODEL_NAME = <span class="string">"f5_tts"</span>
REFERENCE_AUDIO_PATH = <span class="string">"./tts/åŸæ¥å¦‚æ­¤ï¼Œä½ å°†è§è¿‡çš„æ™¯ç‰©è¿›è¡Œäº†è¿™æ ·çš„ç»„åˆã€‚.wav"</span>
REFERENCE_TEXT = <span class="string">"åŸæ¥å¦‚æ­¤ï¼Œä½ å°†è§è¿‡çš„æ™¯ç‰©è¿›è¡Œäº†è¿™æ ·çš„ç»„åˆã€‚"</span>

<span class="comment"># æ—¥å¿—æ–‡ä»¶å¤¹</span>
INPUT_LOG_FOLDER = <span class="string">"./input_logs"</span>
OUTPUT_LOG_FOLDER = <span class="string">"./output_logs"</span>

<span class="comment"># æ€§èƒ½ä¼˜åŒ–å‚æ•°</span>
MAX_WORKERS = <span class="number">4</span>  <span class="comment"># çº¿ç¨‹æ± æœ€å¤§å·¥ä½œçº¿ç¨‹æ•°</span>
BATCH_SIZE = <span class="number">3</span>  <span class="comment"># TTSå¹¶è¡Œåˆæˆçš„æ‰¹æ¬¡å¤§å°</span></pre>
    </div>
    <h3>
     æ€§èƒ½è®¡æ—¶å™¨ç±»
    </h3>
    <div class="class-header">
     PerformanceTimer ç±»
    </div>
    <div class="code-block">
     <div class="language-label">
      Python
     </div>
     <pre>
<span class="keyword">class</span> <span class="class">PerformanceTimer</span>:
    <span class="keyword">def</span> <span class="function">__init__</span>(<span class="builtin">self</span>):
        <span class="builtin">self</span>.timers = {}
        <span class="builtin">self</span>.start_times = {}

    <span class="keyword">def</span> <span class="function">start</span>(<span class="builtin">self</span>, name):
        <span class="builtin">self</span>.start_times[name] = time.time()

    <span class="keyword">def</span> <span class="function">stop</span>(<span class="builtin">self</span>, name):
        <span class="keyword">if</span> name <span class="keyword">in</span> <span class="builtin">self</span>.start_times:
            elapsed = time.time() - <span class="builtin">self</span>.start_times[name]
            <span class="keyword">if</span> name <span class="keyword">not in</span> <span class="builtin">self</span>.timers:
                <span class="builtin">self</span>.timers[name] = []
            <span class="builtin">self</span>.timers[name].append(elapsed)
            <span class="builtin">print</span>(<span class="string">f"â±ï¸ {name} ç”¨æ—¶: {elapsed:.4f} ç§’"</span>)
            <span class="keyword">return</span> elapsed
        <span class="keyword">return</span> <span class="number">0</span>

    <span class="keyword">def</span> <span class="function">get_average</span>(<span class="builtin">self</span>, name):
        <span class="keyword">if</span> name <span class="keyword">in</span> <span class="builtin">self</span>.timers <span class="keyword">and</span> <span class="builtin">self</span>.timers[name]:
            <span class="keyword">return</span> <span class="builtin">sum</span>(<span class="builtin">self</span>.timers[name]) / <span class="builtin">len</span>(<span class="builtin">self</span>.timers[name])
        <span class="keyword">return</span> <span class="number">0</span>

    <span class="keyword">def</span> <span class="function">print_stats</span>(<span class="builtin">self</span>):
        <span class="builtin">print</span>(<span class="string">"\n===== æ€§èƒ½ç»Ÿè®¡ ====="</span>)
        <span class="keyword">for</span> name, times <span class="keyword">in</span> <span class="builtin">self</span>.timers.items():
            <span class="keyword">if</span> times:
                avg = <span class="builtin">sum</span>(times) / <span class="builtin">len</span>(times)
                max_time = <span class="builtin">max</span>(times)
                min_time = <span class="builtin">min</span>(times)
                <span class="builtin">print</span>(<span class="string">f"{name}: å¹³å‡ {avg:.4f}ç§’, æœ€å° {min_time:.4f}ç§’, æœ€å¤§ {max_time:.4f}ç§’, å…± {len(times)} æ¬¡"</span>)</pre>
    </div>
    <h3>
     TTS å®¢æˆ·ç«¯ç±»
    </h3>
    <div class="class-header">
     FastTTSClient ç±»
    </div>
    <div class="code-block">
     <div class="language-label">
      Python
     </div>
     <pre>
<span class="keyword">class</span> <span class="class">FastTTSClient</span>:
    <span class="keyword">def</span> <span class="function">__init__</span>(<span class="builtin">self</span>, server_url=TTS_SERVER_URL, model_name=TTS_MODEL_NAME):
        <span class="builtin">self</span>.server_url = <span class="string">f"http://{server_url}/v2/models/{model_name}/infer"</span>
        <span class="builtin">self</span>.session = requests.Session()
        <span class="builtin">self</span>.reference_audio_path = REFERENCE_AUDIO_PATH
        <span class="builtin">self</span>.reference_text = REFERENCE_TEXT
        <span class="builtin">self</span>.samples, <span class="builtin">self</span>.lengths = <span class="builtin">self</span>.load_reference_audio(<span class="builtin">self</span>.reference_audio_path)
        <span class="builtin">self</span>.text_splitter = TextSplitter()
        <span class="builtin">self</span>.audio_queue = queue.Queue()
        <span class="builtin">self</span>.is_playing = <span class="boolean">False</span>
        <span class="builtin">self</span>.executor = concurrent.futures.ThreadPoolExecutor(max_workers=MAX_WORKERS)
        <span class="builtin">self</span>.response_cache = {}  <span class="comment"># ç¼“å­˜TTSå“åº”</span>
        <span class="builtin">self</span>.timer = PerformanceTimer()
        <span class="builtin">self</span>.warmup()</pre>
    </div>
    <div class="method-header">
     clean_text æ–¹æ³•
    </div>
    <div class="code-block">
     <div class="language-label">
      Python
     </div>
     <pre>
    <span class="keyword">@staticmethod</span>
    <span class="keyword">def</span> <span class="function">clean_text</span>(text: <span class="builtin">str</span>) -&gt; <span class="builtin">str</span>:
        <span class="string">"""æ¸…ç†æ–‡æœ¬ä¸­çš„ç‰¹æ®Šå­—ç¬¦å’Œä¸å¿…è¦çš„ç©ºç™½"""</span>
        text = text.replace(<span class="string">'\n'</span>, <span class="string">' '</span>)
        text = text.replace(<span class="string">'\t'</span>, <span class="string">' '</span>)
        text = <span class="string">' '</span>.join(text.split())
        special_chars = [<span class="string">'\r'</span>, <span class="string">'\xa0'</span>, <span class="string">'\u3000'</span>, <span class="string">'\u200b'</span>, <span class="string">'\u200c'</span>, <span class="string">'\u200d'</span>, <span class="string">'*'</span>] + [<span class="string">f"{i}."</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="builtin">range</span>(<span class="number">10</span>)]
        <span class="keyword">for</span> char <span class="keyword">in</span> special_chars:
            text = text.replace(char, <span class="string">''</span>)
        <span class="keyword">return</span> text.strip()</pre>
    </div>
    <div class="method-header">
     synthesize_and_play æ–¹æ³•
    </div>
    <div class="code-block">
     <div class="language-label">
      Python
     </div>
     <pre>
    <span class="keyword">def</span> <span class="function">synthesize_and_play</span>(<span class="builtin">self</span>, text: <span class="builtin">str</span>):
        <span class="builtin">self</span>.timer.start(<span class="string">"TTSæ€»è€—æ—¶"</span>)

        <span class="comment"># æ¸…ç†æ–‡æœ¬</span>
        cleaned_text = <span class="builtin">self</span>.clean_text(text)

        <span class="comment"># åˆ†å‰²æ–‡æœ¬ä¸ºå¤šä¸ªç‰‡æ®µ</span>
        <span class="builtin">self</span>.timer.start(<span class="string">"æ–‡æœ¬åˆ†å‰²"</span>)
        segments = <span class="builtin">self</span>.text_splitter.split_text(cleaned_text)
        <span class="builtin">self</span>.timer.stop(<span class="string">"æ–‡æœ¬åˆ†å‰²"</span>)

        <span class="keyword">if</span> <span class="keyword">not</span> segments:
            <span class="keyword">return</span>

        <span class="comment"># åˆ›å»ºæ—¶é—´æˆ³ç”¨äºéŸ³é¢‘æ–‡ä»¶å‘½å</span>
        timestamp = datetime.datetime.now().strftime(<span class="string">"%Y%m%d_%H%M%S"</span>)

        <span class="comment"># é‡ç½®æ’­æ”¾çŠ¶æ€å’Œé˜Ÿåˆ—</span>
        <span class="keyword">with</span> <span class="builtin">self</span>.audio_queue.mutex:
            <span class="builtin">self</span>.audio_queue.queue.clear()
        <span class="builtin">self</span>.is_playing = <span class="boolean">True</span>

        <span class="comment"># å¯åŠ¨æ’­æ”¾çº¿ç¨‹</span>
        player = threading.Thread(target=<span class="builtin">self</span>.player_thread)
        player.daemon = <span class="boolean">True</span>
        player.start()

        <span class="comment"># å­˜å‚¨åˆæˆç»“æœçš„æœ‰åºå­—å…¸ï¼ŒæŒ‰ç´¢å¼•å­˜å‚¨ï¼Œç¡®ä¿æŒ‰é¡ºåºæ’­æ”¾</span>
        segment_results = {}
        segment_done = threading.Event()

        <span class="comment"># è·Ÿè¸ªå½“å‰åº”è¯¥å¤„ç†çš„æ®µè½ç´¢å¼•</span>
        next_segment_index = <span class="number">0</span>
        segments_total = <span class="builtin">len</span>(segments)

        <span class="comment"># å¤„ç†å¹¶æ’­æ”¾ç¬¬ä¸€ä¸ªåˆ†æ®µï¼Œç¡®ä¿å¿«é€Ÿå¼€å§‹</span>
        <span class="builtin">self</span>.timer.start(<span class="string">"é¦–æ®µåˆæˆ"</span>)
        first_audio = <span class="builtin">self</span>.synthesize_segment_sync(segments[<span class="number">0</span>], timestamp, <span class="number">0</span>, segments_total)
        <span class="builtin">self</span>.timer.stop(<span class="string">"é¦–æ®µåˆæˆ"</span>)

        <span class="keyword">if</span> first_audio <span class="keyword">is not</span> <span class="boolean">None</span>:
            <span class="builtin">self</span>.audio_queue.put(first_audio)
            next_segment_index = <span class="number">1</span>

        <span class="comment"># å¦‚æœè¿˜æœ‰æ›´å¤šåˆ†æ®µï¼Œå¯åŠ¨å¹¶è¡Œå¤„ç†</span>
        <span class="keyword">if</span> next_segment_index &lt; segments_total:
            <span class="comment"># çœç•¥éƒ¨åˆ†å¹¶è¡Œå¤„ç†ä»£ç ...</span>

        <span class="comment"># æ ‡è®°æ’­æ”¾å®Œæˆ</span>
        <span class="builtin">self</span>.is_playing = <span class="boolean">False</span>

        <span class="comment"># ç­‰å¾…æ’­æ”¾çº¿ç¨‹ç»“æŸ</span>
        player.join()

        <span class="builtin">self</span>.timer.stop(<span class="string">"TTSæ€»è€—æ—¶"</span>)
        <span class="builtin">print</span>(<span class="string">"ğŸ”Š æ‰€æœ‰è¯­éŸ³ç‰‡æ®µæ’­æ”¾å®Œæˆ"</span>)</pre>
    </div>
    <h3>
     TextSplitter ç±»
    </h3>
    <div class="class-header">
     TextSplitter ç±»
    </div>
    <div class="code-block">
     <div class="language-label">
      Python
     </div>
     <pre>
<span class="keyword">class</span> <span class="class">TextSplitter</span>:
    <span class="keyword">def</span> <span class="function">__init__</span>(<span class="builtin">self</span>):
        <span class="comment"># å®šä¹‰åˆ†éš”ç¬¦åŠå…¶ä¼˜å…ˆçº§ï¼ˆæ•°å­—è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜ï¼‰</span>
        <span class="builtin">self</span>.separators = {
            <span class="string">'ã€‚'</span>: <span class="number">5</span>,
            <span class="string">'ï¼'</span>: <span class="number">5</span>,
            <span class="string">'ï¼Ÿ'</span>: <span class="number">5</span>,
            <span class="string">'ï¼›'</span>: <span class="number">4</span>,
            <span class="string">'\n'</span>: <span class="number">4</span>,
            <span class="string">'ï¼Œ'</span>: <span class="number">3</span>,
            <span class="string">'ï¼š'</span>: <span class="number">3</span>,
            <span class="string">'ã€'</span>: <span class="number">2</span>,
            <span class="string">' '</span>: <span class="number">1</span>
        }
        <span class="comment"># å‡å°‘ç›®æ ‡tokené•¿åº¦ä»¥åŠ å¿«TTSå“åº”</span>
        <span class="builtin">self</span>.target_length = <span class="number">30</span>
        <span class="comment"># æœç´¢çª—å£å¤§å°</span>
        <span class="builtin">self</span>.window_size = <span class="number">10</span>

    <span class="keyword">def</span> <span class="function">find_best_split_position</span>(<span class="builtin">self</span>, text, start_pos, target_pos):
        <span class="string">"""åœ¨ç›®æ ‡ä½ç½®é™„è¿‘å¯»æ‰¾æœ€ä½³åˆ†å‰²ç‚¹"""</span>
        best_pos = -<span class="number">1</span>
        best_priority = -<span class="number">1</span>

        <span class="comment"># åœ¨ç›®æ ‡ä½ç½®å‰åçš„çª—å£å†…å¯»æ‰¾æœ€ä½³åˆ†å‰²ç‚¹</span>
        search_start = <span class="builtin">max</span>(start_pos, target_pos - <span class="builtin">self</span>.window_size)
        search_end = <span class="builtin">min</span>(<span class="builtin">len</span>(text), target_pos + <span class="builtin">self</span>.window_size)

        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="builtin">range</span>(search_start, search_end):
            <span class="keyword">if</span> i &gt;= <span class="builtin">len</span>(text):
                <span class="keyword">break</span>

            char = text[i]
            <span class="keyword">if</span> char <span class="keyword">in</span> <span class="builtin">self</span>.separators:
                priority = <span class="builtin">self</span>.separators[char]
                <span class="keyword">if</span> priority &gt; best_priority:
                    best_pos = i
                    best_priority = priority

        <span class="comment"># å¦‚æœæ²¡æ‰¾åˆ°åˆé€‚çš„åˆ†å‰²ç‚¹ï¼Œå°±åœ¨ç›®æ ‡ä½ç½®å¤„å¼ºåˆ¶åˆ†å‰²</span>
        <span class="keyword">if</span> best_pos == -<span class="number">1</span>:
            <span class="keyword">return</span> target_pos

        <span class="keyword">return</span> best_pos + <span class="number">1</span>  <span class="comment"># è¿”å›åˆ†éš”ç¬¦åçš„ä½ç½®</span>

    <span class="keyword">def</span> <span class="function">split_text</span>(<span class="builtin">self</span>, text):
        <span class="string">"""å°†æ–‡æœ¬åˆ†å‰²æˆè¾ƒå°çš„ç‰‡æ®µ"""</span>
        <span class="keyword">if</span> <span class="keyword">not</span> text <span class="keyword">or</span> <span class="builtin">len</span>(text.strip()) == <span class="number">0</span>:
            <span class="keyword">return</span> []

        segments = []
        start = <span class="number">0</span>

        <span class="keyword">while</span> start &lt; <span class="builtin">len</span>(text):
            <span class="comment"># çœç•¥éƒ¨åˆ†åˆ†å‰²é€»è¾‘...</span>

        <span class="keyword">return</span> segments</pre>
    </div>
    <h3>
     AudioRecorder ç±»
    </h3>
    <div class="class-header">
     AudioRecorder ç±»
    </div>
    <div class="code-block">
     <div class="language-label">
      Python
     </div>
     <pre>
<span class="keyword">class</span> <span class="class">AudioRecorder</span>:
    <span class="keyword">def</span> <span class="function">__init__</span>(<span class="builtin">self</span>, timer):
        <span class="builtin">self</span>.p = pyaudio.PyAudio()
        <span class="builtin">self</span>.stream = <span class="boolean">None</span>
        <span class="builtin">self</span>.frames = []
        <span class="builtin">self</span>.is_recording = <span class="boolean">False</span>
        <span class="builtin">self</span>.silence_frames = <span class="number">0</span>
        <span class="builtin">self</span>.is_speaking = <span class="boolean">False</span>
        <span class="builtin">self</span>.timer = timer

        <span class="comment"># ä¼˜åŒ–éŸ³é‡æ£€æµ‹å‚æ•°</span>
        <span class="builtin">self</span>.volume_threshold = <span class="number">0.015</span>  <span class="comment"># ç¨å¾®é™ä½é˜ˆå€¼æé«˜çµæ•åº¦</span>
        <span class="builtin">self</span>.min_speak_frames = <span class="builtin">int</span>(<span class="number">0.15</span> * RATE / CHUNK)  <span class="comment"># å‡å°‘æœ€å°‘è¯´è¯å¸§æ•°(150ms)</span>
        <span class="builtin">self</span>.pre_buffer = []  <span class="comment"># é¢„ç¼“å†²åŒº</span>
        <span class="builtin">self</span>.pre_buffer_size = <span class="builtin">int</span>(<span class="number">0.3</span> * RATE / CHUNK)  <span class="comment"># å‡å°‘é¢„ç¼“å†²(300ms)ä»¥é™ä½å»¶è¿Ÿ</span>
        <span class="builtin">self</span>.speak_frames = <span class="number">0</span>  <span class="comment"># è¯´è¯å¸§è®¡æ•°</span>

        <span class="comment"># æ³¢å½¢èƒ½é‡è®¡ç®—çš„æ»‘åŠ¨çª—å£</span>
        <span class="builtin">self</span>.energy_window_size = <span class="number">10</span>
        <span class="builtin">self</span>.energy_window = []

    <span class="keyword">def</span> <span class="function">process_audio</span>(<span class="builtin">self</span>):
        <span class="keyword">if</span> <span class="keyword">not</span> <span class="builtin">self</span>.stream:
            <span class="keyword">return</span> <span class="boolean">False</span>

        data = np.frombuffer(<span class="builtin">self</span>.stream.read(CHUNK), dtype=np.float32)

        <span class="comment"># è®¡ç®—å½“å‰å¸§çš„èƒ½é‡</span>
        energy = np.sqrt(np.mean(data ** <span class="number">2</span>))

        <span class="comment"># æ›´æ–°èƒ½é‡çª—å£</span>
        <span class="builtin">self</span>.energy_window.append(energy)
        <span class="keyword">if</span> <span class="builtin">len</span>(<span class="builtin">self</span>.energy_window) &gt; <span class="builtin">self</span>.energy_window_size:
            <span class="builtin">self</span>.energy_window.pop(<span class="number">0</span>)

        <span class="comment"># ä½¿ç”¨æ»‘åŠ¨çª—å£å¹³å‡èƒ½é‡è¿›è¡Œæ›´ç¨³å®šçš„æ£€æµ‹</span>
        avg_energy = np.mean(<span class="builtin">self</span>.energy_window) <span class="keyword">if</span> <span class="builtin">self</span>.energy_window <span class="keyword">else</span> energy

        <span class="comment"># çœç•¥åç»­è¯­éŸ³æ£€æµ‹å¤„ç†é€»è¾‘...</span>

        <span class="keyword">return</span> <span class="boolean">False</span></pre>
    </div>
    <h3>
     ä¸»å‡½æ•°
    </h3>
    <div class="code-block">
     <div class="language-label">
      Python
     </div>
     <pre>
<span class="keyword">def</span> <span class="function">main</span>():
    <span class="comment"># åˆ›å»ºæ—¥å¿—æ–‡ä»¶å¤¹</span>
    os.makedirs(INPUT_LOG_FOLDER, exist_ok=<span class="boolean">True</span>)
    os.makedirs(OUTPUT_LOG_FOLDER, exist_ok=<span class="boolean">True</span>)

    <span class="comment"># åˆ›å»ºæ€§èƒ½è®¡æ—¶å™¨</span>
    timer = PerformanceTimer()

    <span class="builtin">print</span>(<span class="string">"åŠ è½½ASRæ¨¡å‹ä¸­..."</span>)
    timer.start(<span class="string">"ASRæ¨¡å‹åŠ è½½"</span>)

    <span class="comment"># ä¼˜åŒ–åçš„ASRæ¨¡å‹é…ç½®</span>
    asr_model = WhisperModel(
        ASR_MODEL_PATH,
        device=<span class="string">"cuda"</span>,
        compute_type=<span class="string">"float16"</span>,
        cpu_threads=<span class="number">4</span>,  <span class="comment"># å¢åŠ CPUçº¿ç¨‹æ•°</span>
        num_workers=<span class="number">2</span>,  <span class="comment"># å¢åŠ å·¥ä½œçº¿ç¨‹</span>
        download_root=ASR_MODEL_PATH,
        local_files_only=<span class="boolean">True</span>  <span class="comment"># ä»…ä½¿ç”¨æœ¬åœ°æ–‡ä»¶ï¼Œé¿å…ç½‘ç»œå»¶è¿Ÿ</span>
    )

    timer.stop(<span class="string">"ASRæ¨¡å‹åŠ è½½"</span>)

    <span class="comment"># åˆå§‹åŒ–LLMå®¢æˆ·ç«¯</span>
    client = OpenAI(base_url=LLM_BASE_URL, api_key=LLM_API_KEY)

    system_prompt = <span class="string">"""ä½ çš„åå­—æ˜¯çº³è¥¿å¦²ï¼Œä½ çš„æ¯ä¸€å¥è¯éƒ½åº”è¯¥ä½“ç°å‡ºå¯¹ä¸‡ç‰©çš„å°Šé‡å’Œå¯¹çŸ¥è¯†çš„æ¸´æœ›ã€‚
    åœ¨ä¸äººäº¤è°ˆæ—¶ï¼Œç”¨è¯—ä¸€èˆ¬çš„è¯­è¨€æè¿°è‡ªç„¶ä¹‹ç¾ï¼Œå±•ç¤ºä½ å¯¹æ¢¦å¢ƒå’Œç°å®çš„æ·±åˆ»ç†è§£ã€‚ä½ çš„è¯è¯­ä¸­åº”è¯¥è•´å«ç€å¯¹ç”Ÿå‘½å¥¥ç§˜çš„æ€è€ƒå’Œå¯¹æœªæ¥çš„å¸Œæœ›ã€‚
    åœ¨å¯¹è¯ä¸­ï¼Œä½ å¯ä»¥è¡¨ç°å‡ºå¯¹åˆ«äººçš„å‹å–„å’Œå¥½å¥‡å¿ƒï¼Œè¯¢é—®ä»–ä»¬çš„æ•…äº‹å¹¶åˆ†äº«ä½ çš„æ™ºæ…§ã€‚
    """</span>
    <span class="comment"># å¤šè½®å¯¹è¯å†å²</span>
    conversation_history = [
        {<span class="string">"role"</span>: <span class="string">"system"</span>, <span class="string">"content"</span>: system_prompt},
    ]

    <span class="comment"># åˆå§‹åŒ–TTSå®¢æˆ·ç«¯</span>
    tts_client = FastTTSClient()

    <span class="comment"># åˆå§‹åŒ–å½•éŸ³å™¨</span>
    recorder = AudioRecorder(timer)

    <span class="builtin">print</span>(<span class="string">"ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼Œè¯·å¼€å§‹å¯¹è¯..."</span>)

    <span class="comment"># ä¸»å¯¹è¯å¾ªç¯...</span></pre>
    </div>
   </div>
   <div class="section">
    <h2>
     ä¼˜åŒ–è¦ç‚¹
    </h2>
    <ul>
     <li>
      <strong>
       å½•éŸ³ä¼˜åŒ–
      </strong>
      ï¼šä½¿ç”¨èƒ½é‡æ£€æµ‹å’Œæ»‘åŠ¨çª—å£å¢å¼ºè¯­éŸ³å¼€å§‹/ç»“æŸæ£€æµ‹çš„ç¨³å®šæ€§
     </li>
     <li>
      <strong>
       é¢„ç¼“å†²
      </strong>
      ï¼šä¿ç•™300msçš„éŸ³é¢‘é¢„ç¼“å†²ï¼Œç¡®ä¿æ•æ‰è¯´è¯å¼€å§‹éƒ¨åˆ†
     </li>
     <li>
      <strong>
       TTSå¹¶è¡Œ
      </strong>
      ï¼šé¦–æ®µä¼˜å…ˆåˆæˆå¹¶æ’­æ”¾ï¼Œå…¶ä½™å¹¶è¡Œå¤„ç†ï¼Œå‡å°‘æ„ŸçŸ¥å»¶è¿Ÿ
     </li>
     <li>
      <strong>
       ç»“æœç¼“å­˜
      </strong>
      ï¼šç¼“å­˜TTSå“åº”ï¼Œå¯¹é‡å¤æ–‡æœ¬å¿«é€Ÿå“åº”
     </li>
     <li>
      <strong>
       æ–‡æœ¬åˆ†å‰²
      </strong>
      ï¼šæ™ºèƒ½åˆ†æ®µï¼Œä¼˜å…ˆåœ¨è‡ªç„¶æ–­å¥å¤„åˆ†å‰²
     </li>
     <li>
      <strong>
       æ€§èƒ½ç›‘æ§
      </strong>
      ï¼šè¯¦ç»†çš„æ€§èƒ½è®¡æ—¶ï¼Œæ–¹ä¾¿å®šä½ç“¶é¢ˆ
     </li>
    </ul>
   </div>
   <div class="footer">
    <p>
     ASR-LLM-TTS é«˜æ•ˆè¯­éŸ³å¯¹è¯ç³»ç»Ÿ | åŸºäº Faster-Whisper-Turbo, vLLM, F5-TTS
    </p>
   </div>
  </div>
 </body>
</html>
